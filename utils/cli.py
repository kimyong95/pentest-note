import click
import docker
import os
import logging

@click.group()
def cli():
    pass

@cli.command()
@click.option("-p", "--path", default=os.getcwd(), help="Path in container", type=click.Path(exists=True))
def get_host_path(path):
    path: str = os.path.abspath(path)
    
    cid: str
    with open("/proc/1/cpuset") as f:
        cid = os.path.basename(f.readline()).strip()
    client = docker.from_env()
    c = client.containers.get(cid)
    mounts = c.attrs["Mounts"]
    for m in mounts:
        if path.startswith(m["Destination"]):
            sub_path = path.lstrip(m["Destination"])
            host_path = os.path.join(m["Source"], sub_path)
            click.echo(host_path)
            return 0
            
    raise Exception(f"Container path [{path}] is not mounted in host")


if __name__ == '__main__':
    cli()